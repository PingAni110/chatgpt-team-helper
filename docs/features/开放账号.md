# 开放账号（含 Credit 订单）功能启用指南

本功能包含：
- 用户侧「开放账号页」：`/redeem/open-accounts`（基于 Linux DO OAuth）
- Credit 订单相关接口与后台管理：`/admin/credit-orders`

> 约定：**Credit 订单归属于开放账号功能**（禁用开放账号即禁用 Credit 订单相关能力）。

## 1) 开启功能开关

- 进入管理后台：`/admin/settings`
- 在「功能开关」中启用「开放账号（含 Credit 订单）」

禁用时相关页面与接口会返回 `403`（`FEATURE_DISABLED`）。

## 2) 配置 Linux DO OAuth

推荐在管理后台配置并入库：
- 进入：`/admin/settings` →「Linux DO OAuth 配置」
- 填写：
  - `LINUXDO_CLIENT_ID`
  - `LINUXDO_CLIENT_SECRET`
  - `LINUXDO_REDIRECT_URI`

## 3) 配置 Linux DO Credit（积分体系）

推荐在管理后台配置并入库：
- 进入：`/admin/settings` →「Linux DO Credit 配置」
- 填写：
  - `LINUXDO_CREDIT_PID`
  - `LINUXDO_CREDIT_KEY`

可选环境变量（见 `backend/.env.example`）：
- `LINUXDO_CREDIT_BASE_URL`（默认 `https://credit.linux.do/epay`）

## 4) 可选：维护模式与业务参数

维护模式（环境变量）：
- `OPEN_ACCOUNTS_ENABLED`：默认 `true`（关闭会提示维护中）
- `OPEN_ACCOUNTS_MAINTENANCE_MESSAGE`

常用业务参数（环境变量，见 `backend/.env.example`）：
- `OPEN_ACCOUNTS_CREDIT_COST`、`OPEN_ACCOUNTS_DAILY_BOARD_LIMIT`
- `OPEN_ACCOUNTS_USER_DAILY_BOARD_LIMIT_ENABLED`、`OPEN_ACCOUNTS_USER_DAILY_BOARD_LIMIT`（每用户每日上车次数限制）
- `CREDIT_ORDER_EXPIRE_MINUTES`、`CREDIT_ORDER_QUERY_MIN_INTERVAL_MS`
- `CREDIT_GATEWAY_SERVER_*`（是否允许服务端查单/退款等）

## 5) 验证

- 访问：`/redeem/open-accounts`
- 完成 Linux DO 授权
- 按页面提示完成下单/上车流程
- 在管理后台查看 Credit 订单：`/admin/credit-orders`

## 6) 22 点账号管理信息刷新（夜间任务）

为避免账号管理页面字段长期滞后，后端新增固定时间调度任务：每天按配置时间执行一次，仅刷新账号管理页已使用字段，不新增日汇总表，也不增加前端汇总展示列。

### 功能说明

- 任务仅刷新已有字段：
  - `user_count`
  - `invite_count`
  - `space_status_code`
  - `space_status_reason`
  - `updated_at`
- 刷新范围：`gpt_accounts` 中 `is_open = 1 AND COALESCE(is_banned, 0) = 0`。
- 单个账号失败不会中断全任务，日志会输出失败账号与错误原因。

### 配置项

- `OPEN_ACCOUNTS_NIGHTLY_SYNC_ENABLED`：是否启用夜间任务（默认 `true`）
- `OPEN_ACCOUNTS_NIGHTLY_SYNC_HOUR`：执行小时（默认 `22`）
- `OPEN_ACCOUNTS_NIGHTLY_SYNC_MINUTE`：执行分钟（默认 `0`）
- `OPEN_ACCOUNTS_NIGHTLY_SYNC_RUN_ON_STARTUP`：服务启动后是否立即执行一次（默认 `false`）
- `OPEN_ACCOUNTS_NIGHTLY_SYNC_CONCURRENCY`：并发账号数（默认 `3`，建议 `1~10`）

### 时区说明

- 默认使用服务端本地时间（Node.js 进程时区）计算下一次触发时间。
- 若部署环境不是东八区，可通过系统时区或 `TZ` 环境变量显式设置为 `Asia/Shanghai`，确保“22:00”含义一致。

### 常见排障

- **任务未执行**：
  - 检查 `OPEN_ACCOUNTS_NIGHTLY_SYNC_ENABLED` 是否被关闭。
  - 检查服务日志是否有“已调度下次执行”“任务开始/结束”字样。
- **时间不对**：
  - 检查容器或主机时区，确认是否为预期时区。
- **失败较多**：
  - 降低 `OPEN_ACCOUNTS_NIGHTLY_SYNC_CONCURRENCY`（例如从 6 调到 3）。
  - 检查代理与 ChatGPT 接口是否出现 429/5xx，系统会做短重试但仍可能因上游不稳定失败。
